<!-- chat application intro page -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/index.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/images/saras-care.jpg">
    <title>SarasCare-AMS</title>
    <style>
    

    .ac-wrap { position: relative; max-width: 600px; }
    #ac-emailInput { width: 100%; } /* optional if you named a different id */
    .ac-dd {
    position: absolute;
    top: calc(100% + 4px);
    left: 0; right: 0;
    max-height: 240px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #fff;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    z-index: 9999;
    }
    .ac-dd .item {
    padding: 10px 12px;
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    }
    .ac-label {  display: flex;
  align-items: center;
  justify-content: center;}
    .ac-dd .item:hover, .ac-dd .item.active { background: #f5f6f7; }
    #button,#button2 {
    background-color: rgb(180, 42, 42); 
    color: rgb(255, 255, 255); 
    border: 1px solid #000000;
    }

    #button:hover,#button2:hover {
    background-color:rgb(255, 255, 255);
    color: rgb(0, 0, 0);
    }
  </style>
</head>
<body>
    <div class="intro_container">
        <div class="intro_content intro_row">
            <div class="intro_col">
                <div class="intro_title">
                    <center>
                        <img style="height:150px;width: 150px;" src="/images/saras-care.jpg" alt="Logo"/>
                        <br><br>
                        <h2>Welcome to SarasCare</h2>                    
                    </center>

                </div>

                

                 <div class="intro_form">

                        <div class="ac-wrap">
                        <h2 class="ac-label">Attendance System</h2>
                        <input id="emailInput" type="text" placeholder="Select or type your email" autocomplete="on" />
                        <div id="emailDropdown" class="ac-dd" hidden></div>
                        </div>
                        <center>
                            <button  class="btns" id="button">Sign In</button>
                            <button  class="btns" id="button2">Sign Off</button>
                        </center>    





                </div>
                
            </div>
            <div class="intro_col">
                <!-- <img src="images/logo.png" alt="logo"> -->
                <div>
                <video style="border: 1px solid rgb(0, 0, 0);" id="webcam" autoplay playsinline width="500" height="400"></video>
                <canvas id="snapshot" width="500" height="400" style="display:none;"></canvas>
                </div>
            </div>
        </div>
    </div>


    

    <!-- <script src="socket.io/socket.io.js"></script> -->
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/3.0.1/mustache.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qs/6.6.0/qs.min.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script type="text/javascript">
        
    $(function() {

    $(function() {

        // Example: this would come from your database/API
      let emails = [
      ];
        (async function loadUsers() {
        try {
            const res = await fetch("/api/users");
            let users = await res.json();
          
            // users.forEach(u => {
            // emails.push(u.UserEmail);
            // });
            // console.log("Loaded emails:", emails);

            //emails = users.filter(e => e.UserEmail && typeof e.UserEmail === "string");
            emails = users.map(u => u.UserEmail).filter(e => e && typeof e === "string");       // extract email string.filter(e => e && typeof e === "string"); // optional: remove null/undefined

            //console.log("Loaded emails:", emails);
    
        } catch (err) {
            console.error("Error loading users", err);
        }
        }());

        const $input = $("#emailInput");
        const $dd = $("#emailDropdown");

        // Render dropdown items
        function render(items) {
        $dd.empty();
        if (!items.length) { $dd.attr("hidden", true); return; }
        // limit results if you like (e.g., items.slice(0, 10))
        $.each(items, function(_, email) {
            $("<div>").addClass("item").text(email).appendTo($dd);
        });
        $dd.removeAttr("hidden");
        }

        // Filter as user types (startsWith; change to includes if you want)
        $input.on("input", function() {
        const q = $(this).val().trim().toLowerCase();
        if (!q) { $dd.attr("hidden", true).empty(); return; }
        const matches = emails.filter(e => e && typeof e === "string" && e.toLowerCase().startsWith(q));
        render(matches);
        });

        // Click to select
        $dd.on("click", ".item", function() {
        const email = $(this).text();
        $input.val(email);
        $dd.attr("hidden", true).empty();
        // Your verification hook:
        // $.post("/verify", { email });
        });

        // Keyboard navigation (optional but useful)
        $input.on("keydown", function(e) {
        const $items = $dd.find(".item");
        if (!$items.length) return;

        let $active = $items.filter(".active");
        if (e.key === "ArrowDown") {
            e.preventDefault();
            $active = $active.length ? $active.removeClass("active").next() : $items.first();
            $active.addClass("active")[0].scrollIntoView({ block: "nearest" });
        } else if (e.key === "ArrowUp") {
            e.preventDefault();
            $active = $active.length ? $active.removeClass("active").prev() : $items.last();
            $active.addClass("active")[0].scrollIntoView({ block: "nearest" });
        } else if (e.key === "Enter") {
            if ($active.length) {
            e.preventDefault();
            $active.click();
            }
        } else if (e.key === "Escape") {
            $dd.attr("hidden", true).empty();
        }
        });

        // Hide on blur (small delay so clicks still register)
        $input.on("blur", function() { setTimeout(() => $dd.attr("hidden", true).empty(), 150); });
        $input.on("focus", function() {
        // Re-show if there are matches for current value
        const q = $input.val().trim().toLowerCase();
        if (!q) return;
        const matches = emails.filter(e => e && typeof e === "string" && e.toLowerCase().startsWith(q));
        render(matches);
        });


       

        // $("#button").click(function() {


        //     });

        // Sign Off -> remove cookie and switch buttons
        // $("#button2").click(function() {

            
            

            
            
        // });
    });

    async function requestWebcam() {

         function updateDatabase(email,action_x)
        {
            const datetime = getFormattedDateTime();

            $.ajax({
                url: "/api/updatedb",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                email: email,
                datetime: datetime,
                action: action_x
                }),
                success: function(res) {
                //console.log("API response:", res);
                },
                error: function(err) {
                console.error("API error:", err);
                }
            });
        }
        
        let userLoggedIn = getCookie("userLoggedIn");
            if(userLoggedIn) {
            $("#button").hide();
            $("#button2").show();
            }
            else
            {
            $("#button").show();
            $("#button2").hide();
        }

        try {
            // 1. Request webcam once
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            const video = document.getElementById("webcam");
            const canvas = document.getElementById("snapshot");
            const captureBtn = document.getElementById("button");
            const captureBtn2 = document.getElementById("button2");

            video.srcObject = stream;
            video.play();


            function video_input(sx)
            {
                const context = canvas.getContext("2d");
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                const datetime = new Date();
                const formattedDate = datetime.toString().replace(/[:.]/g, "-");

                const now = new Date();

                const options = {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true // Ensures 12-hour format with AM/PM
                };

                // Use 'en-GB' locale for dd/mm/yyyy date format and 12-hour time
                const fmt = new Intl.DateTimeFormat('en-GB', options).format(now).toString().replace(/[/.,]/g, "-");

                // console.log(fmt);
                // console.log("Formatted Date:", formattedDate);


                const email = $("#emailInput").val();

                // Define action here, e.g., 'sign-in' or 'sign-off'
                const action = $("#actionInput").val() || sx;

                // const fileName = `${email}_${action}_${fmt}.png`;

                const formData = new FormData();
                formData.append("photo", canvas.toBlob((blob) => {
                    formData.append("photo", blob);
                    
                    formData.append("email", email);
                    formData.append("action", action);
                    formData.append("datetime", fmt);

                    // Send to backend
                    fetch("/user-verification", {
                        method: "POST",
                        body: formData
                    })
                    .then(res => res.json())
                    .then(data => {console.log("API response:", data);
                        if (data.error) {
                            alert("Error: " + data.error);
                        } else {

                            if( action === "Sign-In") 
                             {   
                             alert("Signed In successfully!");
                             }
                             else
                             {
                                alert("Signed Off successfully!");
                             }
                        }
                    })
                    .catch(err => console.error(err));

                }, "image/png"));
            }

            // 2. Capture snapshot on button click
            captureBtn.addEventListener("click", () => {
               
            if(getCookie("userSet") == "true") {
                alert("Only one time signing allowed per day.");
            }
            else if($("#emailInput").val() == "") {
                alert("Please enter your email to sign in");
            }

            else{    
                setCookie("userLoggedIn", "true");
                setCookie("userEmail",$("#emailInput").val());
                setCookie("userSet", "true");
                updateDatabase($("#emailInput").val(),"Sign-In");
                $("#button").hide();
                $("#button2").show();
                video_input("Sign-In");
            }
            });
            captureBtn2.addEventListener("click", () => {
                checkValidEmail = getCookie("userEmail");
            if($("#emailInput").val() == "") {
                alert("Please enter your email to sign off");
            }
            else if(checkValidEmail==$("#emailInput").val() ) {
                deleteCookie("userLoggedIn");
                deleteCookie("userEmail");
                updateDatabase($("#emailInput").val(),"Sign-Off");
                $("#button2").hide();
                $("#button").show();
                video_input("Sign-Off");
                
            }
            else {
                alert("Please use your email only to sign off.");
            }
               
            });

        } catch (err) {
            if (err.name === "NotAllowedError") {
                alert("Webcam access denied. Please enable it in browser settings.");
            } else if (err.name === "NotFoundError") {
                alert("No webcam found on this device.");
            } else {
                console.error("Error accessing webcam:", err);
                alert("Cannot access webcam: " + err.message);
            }
        }
    }

    requestWebcam();
});

  
    // Get cookie
    function getCookie(name) {
    let cookieArr = document.cookie.split(";");
    for (let i = 0; i < cookieArr.length; i++) {
        let cookiePair = cookieArr[i].trim().split("=");
        if (cookiePair[0] === name) {
        return decodeURIComponent(cookiePair[1]);
        }
    }
    return null;
    }

    // Set cookie
    function setCookie(name, value) {
    let date = new Date();
    date.setTime(date.getTime() + (3600000));
    document.cookie = `${name}=${encodeURIComponent(value)}; expires=${date.toUTCString()}; path=/`;
    }

    // Delete cookie
    function deleteCookie(name) {
    document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;
    }

    
// Get formatted date-time string (dd-mm-yyyy HH:MM AM/PM)
function getFormattedDateTime() {
  const now = new Date();

  let dd = String(now.getDate()).padStart(2, "0");
  let mm = String(now.getMonth() + 1).padStart(2, "0");
  let yyyy = now.getFullYear();

  let hours = now.getHours();
  let minutes = String(now.getMinutes()).padStart(2, "0");
  let ampm = hours >= 12 ? "PM" : "AM";
  hours = hours % 12 || 12;

  const time = `${hours}:${minutes} ${ampm}`;
  return `${dd}-${mm}-${yyyy} ${time}`;
}

  

    </script>
</body>
</html>